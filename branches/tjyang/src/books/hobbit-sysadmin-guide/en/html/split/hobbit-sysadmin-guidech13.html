<?xml version="1.0" encoding="iso-8859-1" ?> 
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">  
<!--http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd-->  
<html xmlns="http://www.w3.org/1999/xhtml"  
> 
<head><title>13 Advanced uses of Mercurial Queues</title> 
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)" /> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)" /> 
<!-- html4-uni,2,html,xhtml --> 
<meta name="src" content="hobbit-sysadmin-guide.tex" /> 
<meta name="date" content="2008-04-26 19:37:00" /> 
<link rel="stylesheet" type="text/css" href="hobbit-sysadmin-guide.css" /> 
</head><body 
>
   <!--l. 1--><div class="crosslinks"><p class="noindent">[<a 
href="hobbit-sysadmin-guidech14.html" >next</a>] [<a 
href="hobbit-sysadmin-guidech12.html" >prev</a>] [<a 
href="hobbit-sysadmin-guidech12.html#tailhobbit-sysadmin-guidech12.html" >prev-tail</a>] [<a 
href="#tailhobbit-sysadmin-guidech13.html">tail</a>] [<a 
href="hobbit-sysadmin-guide.html#hobbit-sysadmin-guidech13.html" >up</a>] </p></div>
   <h2 class="chapterHead"><span class="titlemark">Chapter&#x00A0;13</span><br /><a 
 id="x17-30200013"></a>Advanced uses of Mercurial Queues</h2>
<!--l. 4--><p class="noindent">While it&#x2019;s easy to pick up straightforward uses of Mercurial Queues, use of a little discipline and some of MQ&#x2019;s less frequently
used capabilities makes it possible to work in complicated development environments.
</p><!--l. 9--><p class="indent">   In this chapter, I will use as an example a technique I have used to manage the development of an Infiniband device driver
for the Linux kernel. The driver in question is large (at least as drivers go), with 25,000 lines of code spread across 35 source
files. It is maintained by a small team of developers.
</p><!--l. 15--><p class="indent">   While much of the material in this chapter is specific to Linux, the same principles apply to any code base for which you&#x2019;re
not the primary owner, and upon which you need to do a lot of development.
</p>
   <h3 class="sectionHead"><span class="titlemark">13.1    </span> <a 
 id="x17-30300013.1"></a>The problem of many targets</h3>
<!--l. 21--><p class="noindent">The Linux kernel changes rapidly, and has never been internally stable; developers frequently make drastic changes between
releases. This means that a version of the driver that works well with a particular released version of the kernel will not even
<span 
class="ptmri7t-">compile </span>correctly against, typically, any other version.
</p><!--l. 27--><p class="indent">   To maintain a driver, we have to keep a number of distinct versions of Linux in mind. </p>
     <ul><li><span class="dt">
     </span><span class="dd">One target is the main Linux kernel development tree. Maintenance of the code is in this case partly shared by
     other developers in the kernel community, who make &#x201C;drive-by&#x201D; modifications to the driver as they develop and
     refine kernel subsystems.
     </span><li><span class="dt">
     </span><span class="dd">We  also  maintain  a  number  of  &#x201C;backports&#x201D;  to  older  versions  of  the  Linux  kernel,  to  support  the  needs  of
     customers who are running older Linux distributions that do not incorporate our drivers. (To <span 
class="ptmri7t-">backport </span>a piece of
     code is to modify it to work in an older version of its target environment than the version it was developed for.)
     </span><li><span class="dt">
     </span><span class="dd">Finally,  we  make  software  releases  on  a  schedule  that  is  necessarily  not  aligned  with  those  used  by  Linux
     distributors and kernel developers, so that we can deliver new features to customers without forcing them to
     upgrade their entire kernels or distributions.</li></ul>
<!--l. 48--><p class="noindent">
</p>
   <h4 class="subsectionHead"><span class="titlemark">13.1.1    </span> <a 
 id="x17-30400013.1.1"></a>Tempting approaches that don&#x2019;t work well</h4>
<!--l. 50--><p class="noindent">There are two &#x201C;standard&#x201D; ways to maintain a piece of software that has to target many different environments.
</p><!--l. 53--><p class="indent">   The first is to maintain a number of branches, each intended for a single target. The trouble with this approach is that you
must maintain iron discipline in the flow of changes between repositories. A new feature or bug fix must start life in a &#x201C;pristine&#x201D;
repository, then percolate out to every backport repository. Backport changes are more limited in the branches they should
propagate to; a backport change that is applied to a branch where it doesn&#x2019;t belong will probably stop the driver from
compiling.
</p><!--l. 62--><p class="indent">   The second is to maintain a single source tree filled with conditional statements that turn chunks of code on or off
depending on the intended target. Because these &#x201C;ifdefs&#x201D; are not allowed in the Linux kernel tree, a manual or automatic
process must be followed to strip them out and yield a clean tree. A code base maintained in this fashion rapidly becomes a rat&#x2019;s
nest of conditional blocks that are difficult to understand and maintain.
</p><!--l. 70--><p class="indent">   Neither of these approaches is well suited to a situation where you don&#x2019;t &#x201C;own&#x201D; the canonical copy of a
source tree. In the case of a Linux driver that is distributed with the standard kernel, Linus&#x2019;s tree contains the
copy of the code that will be treated by the world as canonical. The upstream version of &#x201C;my&#x201D; driver can be
modified by people I don&#x2019;t know, without me even finding out about it until after the changes show up in Linus&#x2019;s
tree.
                                                                                         
                                                                                         
</p><!--l. 78--><p class="indent">   These approaches have the added weakness of making it difficult to generate well-formed patches to submit
upstream.
</p><!--l. 81--><p class="indent">   In principle, Mercurial Queues seems like a good candidate to manage a development scenario such as the above. While
this is indeed the case, MQ contains a few added features that make the job more pleasant.
</p><!--l. 87--><p class="noindent">
</p>
   <h3 class="sectionHead"><span class="titlemark">13.2    </span> <a 
 id="x17-30500013.2"></a>Conditionally applying patches with guards</h3>
<!--l. 89--><p class="noindent">Perhaps the best way to maintain sanity with so many targets is to be able to choose specific patches to apply for a given
situation. MQ provides a feature called &#x201C;guards&#x201D; (which originates with quilt&#x2019;s <span 
class="pcrr7tn-">guards </span>command) that does just this. To start
off, let&#x2019;s create a simple repository for experimenting in.
</p>
   <div class="fancyvrb" id="fancyvrb">
<a 
 id="x17-305002r1"></a><span 
class="ptmr7t-x-x-50">1</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;$</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrb7t-">hg</span><span 
class="pcrb7t-">&#x00A0;qinit</span>
<br class="fancyvrb" /><a 
 id="x17-305004r2"></a><span 
class="ptmr7t-x-x-50">2</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;$</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrb7t-">hg</span><span 
class="pcrb7t-">&#x00A0;qnew</span><span 
class="pcrb7t-">&#x00A0;hello.patch</span>
<br class="fancyvrb" /><a 
 id="x17-305006r3"></a><span 
class="ptmr7t-x-x-50">3</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;$</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrb7t-">echo</span><span 
class="pcrb7t-">&#x00A0;hello</span><span 
class="pcrb7t-">&#x00A0;&#x003e;</span><span 
class="pcrb7t-">&#x00A0;hello</span>
<br class="fancyvrb" /><a 
 id="x17-305008r4"></a><span 
class="ptmr7t-x-x-50">4</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;$</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrb7t-">hg</span><span 
class="pcrb7t-">&#x00A0;add</span><span 
class="pcrb7t-">&#x00A0;hello</span>
<br class="fancyvrb" /><a 
 id="x17-305010r5"></a><span 
class="ptmr7t-x-x-50">5</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;$</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrb7t-">hg</span><span 
class="pcrb7t-">&#x00A0;qrefresh</span>
<br class="fancyvrb" /><a 
 id="x17-305012r6"></a><span 
class="ptmr7t-x-x-50">6</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;$</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrb7t-">hg</span><span 
class="pcrb7t-">&#x00A0;qnew</span><span 
class="pcrb7t-">&#x00A0;goodbye.patch</span>
<br class="fancyvrb" /><a 
 id="x17-305014r7"></a><span 
class="ptmr7t-x-x-50">7</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;$</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrb7t-">echo</span><span 
class="pcrb7t-">&#x00A0;goodbye</span><span 
class="pcrb7t-">&#x00A0;&#x003e;</span><span 
class="pcrb7t-">&#x00A0;goodbye</span>
<br class="fancyvrb" /><a 
 id="x17-305016r8"></a><span 
class="ptmr7t-x-x-50">8</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;$</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrb7t-">hg</span><span 
class="pcrb7t-">&#x00A0;add</span><span 
class="pcrb7t-">&#x00A0;goodbye</span>
<br class="fancyvrb" /><a 
 id="x17-305018r9"></a><span 
class="ptmr7t-x-x-50">9</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;$</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrb7t-">hg</span><span 
class="pcrb7t-">&#x00A0;qrefresh</span>
   </div>
<!--l. 95--><p class="noindent">This gives us a tiny repository that contains two patches that don&#x2019;t have any dependencies on each other, because they touch
different files.
</p><!--l. 98--><p class="indent">   The idea behind conditional application is that you can &#x201C;tag&#x201D; a patch with a <span 
class="ptmri7t-">guard</span>, which is simply a text string of your
choosing, then tell MQ to select specific guards to use when applying patches. MQ will then either apply, or skip over, a
guarded patch, depending on the guards that you have selected.
</p><!--l. 104--><p class="indent">   A patch can have an arbitrary number of guards; each one is <span 
class="ptmri7t-">positive </span>(&#x201C;apply this patch if this guard is selected&#x201D;) or <span 
class="ptmri7t-">negative</span>
(&#x201C;skip this patch if this guard is selected&#x201D;). A patch with no guards is always applied.
</p><!--l. 109--><p class="noindent">
</p>
   <h3 class="sectionHead"><span class="titlemark">13.3    </span> <a 
 id="x17-30600013.3"></a>Controlling the guards on a patch</h3>
<!--l. 111--><p class="noindent">The <a 
 id="dx17-306001"></a><a 
 id="dx17-306002"></a>&#x201C;<span 
class="pcrr7tn-">hg qguard</span>&#x201D; command lets you determine which guards should apply to a patch, or display the guards that are already in
effect. Without any arguments, it displays the guards on the current topmost patch.
</p>
   <div class="fancyvrb" id="fancyvrb">
<a 
 id="x17-306004r1"></a><span 
class="ptmr7t-x-x-50">1</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;$</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrb7t-">hg</span><span 
class="pcrb7t-">&#x00A0;qguard</span>
<br class="fancyvrb" /><a 
 id="x17-306006r2"></a><span 
class="ptmr7t-x-x-50">2</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;goodbye.patch:</span><span 
class="pcrr7tn-">&#x00A0;unguarded</span>
   </div>
<!--l. 116--><p class="noindent">To set a positive guard on a patch, prefix the name of the guard with a &#x201C;<span 
class="pcrr7tn-">+</span>&#x201D;.
</p>
   <div class="fancyvrb" id="fancyvrb">
                                                                                         
                                                                                         
<a 
 id="x17-306008r1"></a><span 
class="ptmr7t-x-x-50">1</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;$</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrb7t-">hg</span><span 
class="pcrb7t-">&#x00A0;qguard</span><span 
class="pcrb7t-">&#x00A0;+foo</span>
<br class="fancyvrb" /><a 
 id="x17-306010r2"></a><span 
class="ptmr7t-x-x-50">2</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;$</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrb7t-">hg</span><span 
class="pcrb7t-">&#x00A0;qguard</span>
<br class="fancyvrb" /><a 
 id="x17-306012r3"></a><span 
class="ptmr7t-x-x-50">3</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;goodbye.patch:</span><span 
class="pcrr7tn-">&#x00A0;+foo</span>
   </div>
<!--l. 119--><p class="noindent">To set a negative guard on a patch, prefix the name of the guard with a &#x201C;<span 
class="pcrr7tn-">-</span>&#x201D;.
</p>
   <div class="fancyvrb" id="fancyvrb">
<a 
 id="x17-306014r1"></a><span 
class="ptmr7t-x-x-50">1</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;$</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrb7t-">hg</span><span 
class="pcrb7t-">&#x00A0;qguard</span><span 
class="pcrb7t-">&#x00A0;hello.patch</span><span 
class="pcrb7t-">&#x00A0;-quux</span>
<br class="fancyvrb" /><a 
 id="x17-306016r2"></a><span 
class="ptmr7t-x-x-50">2</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;$</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrb7t-">hg</span><span 
class="pcrb7t-">&#x00A0;qguard</span><span 
class="pcrb7t-">&#x00A0;hello.patch</span>
<br class="fancyvrb" /><a 
 id="x17-306018r3"></a><span 
class="ptmr7t-x-x-50">3</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;hello.patch:</span><span 
class="pcrr7tn-">&#x00A0;-quux</span>
   </div>
</p>
   <div class="fbox"><span 
class="ptmb7t-">Note:   </span>The &#x201C;<span 
class="pcrr7tn-">hg qguard</span>&#x201D; command <span 
class="ptmri7t-">sets </span>the guards on a patch; it doesn&#x2019;t <span 
class="ptmri7t-">modify</span>
them. What this means is that if you run &#x201C;<span 
class="pcrr7tn-">hg qguard +a +b</span>&#x201D; on a patch, then &#x201C;<span 
class="pcrr7tn-">hg</span>
<span 
class="pcrr7tn-">qguard +c</span>&#x201D; on the same patch, the <span 
class="ptmri7t-">only </span>guard that will be set on it afterwards is
<span 
class="pcrr7tn-">+c</span>.                                                                                                                              </div>
<!--l. 131--><p class="indent">   Mercurial stores guards in the <a 
 id="dx17-306023"></a><span 
class="pcrr7tn-">series </span>file; the form in which they are stored is easy both to understand and to edit by hand.
(In other words, you don&#x2019;t have to use the <a 
 id="dx17-306024"></a><a 
 id="dx17-306025"></a>&#x201C;<span 
class="pcrr7tn-">hg qguard</span>&#x201D; command if you don&#x2019;t want to; it&#x2019;s okay to simply edit the <a 
 id="dx17-306026"></a><span 
class="pcrr7tn-">series</span>
file.)
</p>
   <div class="fancyvrb" id="fancyvrb">
<a 
 id="x17-306028r1"></a><span 
class="ptmr7t-x-x-50">1</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;$</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrb7t-">cat</span><span 
class="pcrb7t-">&#x00A0;.hg/patches/series</span>
<br class="fancyvrb" /><a 
 id="x17-306030r2"></a><span 
class="ptmr7t-x-x-50">2</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;hello.patch</span><span 
class="pcrr7tn-">&#x00A0;#-quux</span>
<br class="fancyvrb" /><a 
 id="x17-306032r3"></a><span 
class="ptmr7t-x-x-50">3</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;goodbye.patch</span><span 
class="pcrr7tn-">&#x00A0;#+foo</span>
   </div>
<!--l. 138--><p class="noindent">
</p>
   <h3 class="sectionHead"><span class="titlemark">13.4    </span> <a 
 id="x17-30700013.4"></a>Selecting the guards to use</h3>
<!--l. 140--><p class="noindent">The <a 
 id="dx17-307001"></a><a 
 id="dx17-307002"></a>&#x201C;<span 
class="pcrr7tn-">hg qselect</span>&#x201D; command determines which guards are active at a given time. The effect of this is to determine which
patches MQ will apply the next time you run <a 
 id="dx17-307003"></a><a 
 id="dx17-307004"></a>&#x201C;<span 
class="pcrr7tn-">hg qpush</span>&#x201D;. It has no other effect; in particular, it doesn&#x2019;t do anything to patches
that are already applied.
</p><!--l. 146--><p class="indent">   With no arguments, the <a 
 id="dx17-307005"></a><a 
 id="dx17-307006"></a>&#x201C;<span 
class="pcrr7tn-">hg qselect</span>&#x201D; command lists the guards currently in effect, one per line of output. Each argument
is treated as the name of a guard to apply.
</p>
   <div class="fancyvrb" id="fancyvrb">
<a 
 id="x17-307008r1"></a><span 
class="ptmr7t-x-x-50">1</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;$</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrb7t-">hg</span><span 
class="pcrb7t-">&#x00A0;qpop</span><span 
class="pcrb7t-">&#x00A0;-a</span>
<br class="fancyvrb" /><a 
 id="x17-307010r2"></a><span 
class="ptmr7t-x-x-50">2</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;Patch</span><span 
class="pcrr7tn-">&#x00A0;queue</span><span 
class="pcrr7tn-">&#x00A0;now</span><span 
class="pcrr7tn-">&#x00A0;empty</span>
<br class="fancyvrb" /><a 
 id="x17-307012r3"></a><span 
class="ptmr7t-x-x-50">3</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;$</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrb7t-">hg</span><span 
class="pcrb7t-">&#x00A0;qselect</span>
<br class="fancyvrb" /><a 
 id="x17-307014r4"></a><span 
class="ptmr7t-x-x-50">4</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;no</span><span 
class="pcrr7tn-">&#x00A0;active</span><span 
class="pcrr7tn-">&#x00A0;guards</span>
<br class="fancyvrb" /><a 
 id="x17-307016r5"></a><span 
class="ptmr7t-x-x-50">5</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;$</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrb7t-">hg</span><span 
class="pcrb7t-">&#x00A0;qselect</span><span 
class="pcrb7t-">&#x00A0;foo</span>
<br class="fancyvrb" /><a 
 id="x17-307018r6"></a><span 
class="ptmr7t-x-x-50">6</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;number</span><span 
class="pcrr7tn-">&#x00A0;of</span><span 
class="pcrr7tn-">&#x00A0;unguarded,</span><span 
class="pcrr7tn-">&#x00A0;unapplied</span><span 
class="pcrr7tn-">&#x00A0;patches</span><span 
class="pcrr7tn-">&#x00A0;has</span><span 
class="pcrr7tn-">&#x00A0;changed</span><span 
class="pcrr7tn-">&#x00A0;from</span><span 
class="pcrr7tn-">&#x00A0;1</span><span 
class="pcrr7tn-">&#x00A0;to</span><span 
class="pcrr7tn-">&#x00A0;2</span>
<br class="fancyvrb" /><a 
 id="x17-307020r7"></a><span 
class="ptmr7t-x-x-50">7</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;$</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrb7t-">hg</span><span 
class="pcrb7t-">&#x00A0;qselect</span>
<br class="fancyvrb" /><a 
 id="x17-307022r8"></a><span 
class="ptmr7t-x-x-50">8</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;foo</span>
   </div>
<!--l. 150--><p class="noindent">In case you&#x2019;re interested, the currently selected guards are stored in the <a 
 id="dx17-307023"></a><span 
class="pcrr7tn-">guards </span>file.
                                                                                         
                                                                                         
</p>
   <div class="fancyvrb" id="fancyvrb">
<a 
 id="x17-307025r1"></a><span 
class="ptmr7t-x-x-50">1</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;$</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrb7t-">cat</span><span 
class="pcrb7t-">&#x00A0;.hg/patches/guards</span>
<br class="fancyvrb" /><a 
 id="x17-307027r2"></a><span 
class="ptmr7t-x-x-50">2</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;foo</span>
   </div>
<!--l. 153--><p class="noindent">We can see the effect the selected guards have when we run <a 
 id="dx17-307028"></a><a 
 id="dx17-307029"></a>&#x201C;<span 
class="pcrr7tn-">hg qpush</span>&#x201D;.
</p>
   <div class="fancyvrb" id="fancyvrb">
<a 
 id="x17-307031r1"></a><span 
class="ptmr7t-x-x-50">1</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;$</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrb7t-">hg</span><span 
class="pcrb7t-">&#x00A0;qpush</span><span 
class="pcrb7t-">&#x00A0;-a</span>
<br class="fancyvrb" /><a 
 id="x17-307033r2"></a><span 
class="ptmr7t-x-x-50">2</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;applying</span><span 
class="pcrr7tn-">&#x00A0;hello.patch</span>
<br class="fancyvrb" /><a 
 id="x17-307035r3"></a><span 
class="ptmr7t-x-x-50">3</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;applying</span><span 
class="pcrr7tn-">&#x00A0;goodbye.patch</span>
<br class="fancyvrb" /><a 
 id="x17-307037r4"></a><span 
class="ptmr7t-x-x-50">4</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;Now</span><span 
class="pcrr7tn-">&#x00A0;at:</span><span 
class="pcrr7tn-">&#x00A0;goodbye.patch</span>
   </div>
<!--l. 157--><p class="indent">   A guard cannot start with a &#x201C;<span 
class="pcrr7tn-">+</span>&#x201D; or &#x201C;<span 
class="pcrr7tn-">-</span>&#x201D; character. The name of a guard must not contain white space, but most othter
characters are acceptable. If you try to use a guard with an invalid name, MQ will complain:
</p>
   <div class="fancyvrb" id="fancyvrb">
<a 
 id="x17-307039r1"></a><span 
class="ptmr7t-x-x-50">1</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;$</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrb7t-">hg</span><span 
class="pcrb7t-">&#x00A0;qselect</span><span 
class="pcrb7t-">&#x00A0;+foo</span>
<br class="fancyvrb" /><a 
 id="x17-307041r2"></a><span 
class="ptmr7t-x-x-50">2</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;abort:</span><span 
class="pcrr7tn-">&#x00A0;guard</span><span 
class="pcrr7tn-">&#x00A0;'+foo'</span><span 
class="pcrr7tn-">&#x00A0;starts</span><span 
class="pcrr7tn-">&#x00A0;with</span><span 
class="pcrr7tn-">&#x00A0;invalid</span><span 
class="pcrr7tn-">&#x00A0;character:</span><span 
class="pcrr7tn-">&#x00A0;'+'</span>
   </div>
<!--l. 162--><p class="noindent">Changing the selected guards changes the patches that are applied.
</p>
   <div class="fancyvrb" id="fancyvrb">
<a 
 id="x17-307043r1"></a><span 
class="ptmr7t-x-x-50">1</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;$</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrb7t-">hg</span><span 
class="pcrb7t-">&#x00A0;qselect</span><span 
class="pcrb7t-">&#x00A0;quux</span>
<br class="fancyvrb" /><a 
 id="x17-307045r2"></a><span 
class="ptmr7t-x-x-50">2</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;number</span><span 
class="pcrr7tn-">&#x00A0;of</span><span 
class="pcrr7tn-">&#x00A0;guarded,</span><span 
class="pcrr7tn-">&#x00A0;applied</span><span 
class="pcrr7tn-">&#x00A0;patches</span><span 
class="pcrr7tn-">&#x00A0;has</span><span 
class="pcrr7tn-">&#x00A0;changed</span><span 
class="pcrr7tn-">&#x00A0;from</span><span 
class="pcrr7tn-">&#x00A0;0</span><span 
class="pcrr7tn-">&#x00A0;to</span><span 
class="pcrr7tn-">&#x00A0;2</span>
<br class="fancyvrb" /><a 
 id="x17-307047r3"></a><span 
class="ptmr7t-x-x-50">3</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;$</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrb7t-">hg</span><span 
class="pcrb7t-">&#x00A0;qpop</span><span 
class="pcrb7t-">&#x00A0;-a</span>
<br class="fancyvrb" /><a 
 id="x17-307049r4"></a><span 
class="ptmr7t-x-x-50">4</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;Patch</span><span 
class="pcrr7tn-">&#x00A0;queue</span><span 
class="pcrr7tn-">&#x00A0;now</span><span 
class="pcrr7tn-">&#x00A0;empty</span>
<br class="fancyvrb" /><a 
 id="x17-307051r5"></a><span 
class="ptmr7t-x-x-50">5</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;$</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrb7t-">hg</span><span 
class="pcrb7t-">&#x00A0;qpush</span><span 
class="pcrb7t-">&#x00A0;-a</span>
<br class="fancyvrb" /><a 
 id="x17-307053r6"></a><span 
class="ptmr7t-x-x-50">6</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;abort:</span><span 
class="pcrr7tn-">&#x00A0;patch</span><span 
class="pcrr7tn-">&#x00A0;series</span><span 
class="pcrr7tn-">&#x00A0;fully</span><span 
class="pcrr7tn-">&#x00A0;applied</span>
   </div>
<!--l. 164--><p class="noindent">You can see in the example below that negative guards take precedence over positive guards.
</p>
   <div class="fancyvrb" id="fancyvrb">
<a 
 id="x17-307055r1"></a><span 
class="ptmr7t-x-x-50">1</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;$</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrb7t-">hg</span><span 
class="pcrb7t-">&#x00A0;qselect</span><span 
class="pcrb7t-">&#x00A0;foo</span><span 
class="pcrb7t-">&#x00A0;bar</span>
<br class="fancyvrb" /><a 
 id="x17-307057r2"></a><span 
class="ptmr7t-x-x-50">2</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;number</span><span 
class="pcrr7tn-">&#x00A0;of</span><span 
class="pcrr7tn-">&#x00A0;unguarded,</span><span 
class="pcrr7tn-">&#x00A0;unapplied</span><span 
class="pcrr7tn-">&#x00A0;patches</span><span 
class="pcrr7tn-">&#x00A0;has</span><span 
class="pcrr7tn-">&#x00A0;changed</span><span 
class="pcrr7tn-">&#x00A0;from</span><span 
class="pcrr7tn-">&#x00A0;0</span><span 
class="pcrr7tn-">&#x00A0;to</span><span 
class="pcrr7tn-">&#x00A0;2</span>
<br class="fancyvrb" /><a 
 id="x17-307059r3"></a><span 
class="ptmr7t-x-x-50">3</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;$</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrb7t-">hg</span><span 
class="pcrb7t-">&#x00A0;qpop</span><span 
class="pcrb7t-">&#x00A0;-a</span>
<br class="fancyvrb" /><a 
 id="x17-307061r4"></a><span 
class="ptmr7t-x-x-50">4</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;abort:</span><span 
class="pcrr7tn-">&#x00A0;no</span><span 
class="pcrr7tn-">&#x00A0;patches</span><span 
class="pcrr7tn-">&#x00A0;applied</span>
<br class="fancyvrb" /><a 
 id="x17-307063r5"></a><span 
class="ptmr7t-x-x-50">5</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;$</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrb7t-">hg</span><span 
class="pcrb7t-">&#x00A0;qpush</span><span 
class="pcrb7t-">&#x00A0;-a</span>
<br class="fancyvrb" /><a 
 id="x17-307065r6"></a><span 
class="ptmr7t-x-x-50">6</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;applying</span><span 
class="pcrr7tn-">&#x00A0;hello.patch</span>
<br class="fancyvrb" /><a 
 id="x17-307067r7"></a><span 
class="ptmr7t-x-x-50">7</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;applying</span><span 
class="pcrr7tn-">&#x00A0;goodbye.patch</span>
<br class="fancyvrb" /><a 
 id="x17-307069r8"></a><span 
class="ptmr7t-x-x-50">8</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;Now</span><span 
class="pcrr7tn-">&#x00A0;at:</span><span 
class="pcrr7tn-">&#x00A0;goodbye.patch</span>
   </div>
                                                                                         
                                                                                         
<!--l. 168--><p class="noindent">
</p>
   <h3 class="sectionHead"><span class="titlemark">13.5    </span> <a 
 id="x17-30800013.5"></a>MQ&#x2019;s rules for applying patches</h3>
<!--l. 170--><p class="noindent">The rules that MQ uses when deciding whether to apply a patch are as follows. </p>
     <ul><li><span class="dt">
     </span><span class="dd">A patch that has no guards is always applied.
     </span><li><span class="dt">
     </span><span class="dd">If the patch has any negative guard that matches any currently selected guard, the patch is skipped.
     </span><li><span class="dt">
     </span><span class="dd">If the patch has any positive guard that matches any currently selected guard, the patch is applied.
     </span><li><span class="dt">
     </span><span class="dd">If the patch has positive or negative guards, but none matches any currently selected guard, the patch is skipped.</li></ul>
<!--l. 182--><p class="noindent">
</p>
   <h3 class="sectionHead"><span class="titlemark">13.6    </span> <a 
 id="x17-30900013.6"></a>Trimming the work environment</h3>
<!--l. 184--><p class="noindent">In working on the device driver I mentioned earlier, I don&#x2019;t apply the patches to a normal Linux kernel tree. Instead, I use a
repository that contains only a snapshot of the source files and headers that are relevant to Infiniband development. This
repository is&#x00A0;1% the size of a kernel repository, so it&#x2019;s easier to work with.
</p><!--l. 190--><p class="indent">   I then choose a &#x201C;base&#x201D; version on top of which the patches are applied. This is a snapshot of the Linux kernel tree as of a
revision of my choosing. When I take the snapshot, I record the changeset ID from the kernel repository in the commit
message. Since the snapshot preserves the &#x201C;shape&#x201D; and content of the relevant parts of the kernel tree, I can apply my patches
on top of either my tiny repository or a normal kernel tree.
</p><!--l. 198--><p class="indent">   Normally, the base tree atop which the patches apply should be a snapshot of a very recent upstream tree. This best
facilitates the development of patches that can easily be submitted upstream with few or no modifications.
</p><!--l. 203--><p class="noindent">
</p>
   <h3 class="sectionHead"><span class="titlemark">13.7    </span> <a 
 id="x17-31000013.7"></a>Dividing up the <span 
class="pcrr7tn-">series </span>file</h3>
<!--l. 205--><p class="noindent">I categorise the patches in the <a 
 id="dx17-310001"></a><span 
class="pcrr7tn-">series </span>file into a number of logical groups. Each section of like patches begins with a block of
comments that describes the purpose of the patches that follow.
</p><!--l. 209--><p class="indent">   The sequence of patch groups that I maintain follows. The ordering of these groups is important; I&#x2019;ll describe why after I
introduce the groups. </p>
     <ul><li><span class="dt">
     </span><span class="dd">The &#x201C;accepted&#x201D; group. Patches that the development team has submitted to the maintainer of the Infiniband
     subsystem, and which he has accepted, but which are not present in the snapshot that the tiny repository is based
     on. These are &#x201C;read only&#x201D; patches, present only to transform the tree into a similar state as it is in the upstream
     maintainer&#x2019;s repository.
     </span><li><span class="dt">
     </span><span class="dd">The &#x201C;rework&#x201D; group. Patches that I have submitted, but that the upstream maintainer has requested modifications
     to before he will accept them.
                                                                                         
                                                                                         
     </span><li><span class="dt">
     </span><span class="dd">The &#x201C;pending&#x201D; group. Patches that I have not yet submitted to the upstream maintainer, but which we have
     finished  working  on.  These  will  be  &#x201C;read  only&#x201D;  for  a  while.  If  the  upstream  maintainer  accepts  them  upon
     submission, I&#x2019;ll move them to the end of the &#x201C;accepted&#x201D; group. If he requests that I modify any, I&#x2019;ll move them
     to the beginning of the &#x201C;rework&#x201D; group.
     </span><li><span class="dt">
     </span><span class="dd">The &#x201C;in progress&#x201D; group. Patches that are actively being developed, and should not be submitted anywhere yet.
     </span><li><span class="dt">
     </span><span class="dd">The &#x201C;backport&#x201D; group. Patches that adapt the source tree to older versions of the kernel tree.
     </span><li><span class="dt">
     </span><span class="dd">The &#x201C;do not ship&#x201D; group. Patches that for some reason should never be submitted upstream. For example, one
     such patch might change embedded driver identification strings to make it easier to distinguish, in the field,
     between an out-of-tree version of the driver and a version shipped by a distribution vendor.</li></ul>
<!--l. 239--><p class="indent">   Now to return to the reasons for ordering groups of patches in this way. We would like the lowest patches in the stack to be
as stable as possible, so that we will not need to rework higher patches due to changes in context. Putting patches that will never
be changed first in the <a 
 id="dx17-310002"></a><span 
class="pcrr7tn-">series </span>file serves this purpose.
</p><!--l. 245--><p class="indent">   We would also like the patches that we know we&#x2019;ll need to modify to be applied on top of a source tree
that resembles the upstream tree as closely as possible. This is why we keep accepted patches around for a
while.
</p><!--l. 250--><p class="indent">   The &#x201C;backport&#x201D; and &#x201C;do not ship&#x201D; patches float at the end of the <a 
 id="dx17-310003"></a><span 
class="pcrr7tn-">series </span>file. The backport patches must be applied on top
of all other patches, and the &#x201C;do not ship&#x201D; patches might as well stay out of harm&#x2019;s way.
</p><!--l. 255--><p class="noindent">
</p>
   <h3 class="sectionHead"><span class="titlemark">13.8    </span> <a 
 id="x17-31100013.8"></a>Maintaining the patch series</h3>
<!--l. 257--><p class="noindent">In my work, I use a number of guards to control which patches are to be applied.
</p>
     <ul><li><span class="dt">
     </span><span class="dd">&#x201C;Accepted&#x201D; patches are guarded with <span 
class="pcrr7tn-">accepted</span>. I enable this guard most of the time. When I&#x2019;m applying the
     patches on top of a tree where the patches are already present, I can turn this patch off, and the patches that
     follow it will apply cleanly.
     </span><li><span class="dt">
     </span><span class="dd">Patches that are &#x201C;finished&#x201D;, but not yet submitted, have no guards. If I&#x2019;m applying the patch stack to a copy of
     the upstream tree, I don&#x2019;t need to enable any guards in order to get a reasonably safe source tree.
     </span><li><span class="dt">
     </span><span class="dd">Those patches that need reworking before being resubmitted are guarded with <span 
class="pcrr7tn-">rework</span>.
     </span><li><span class="dt">
     </span><span class="dd">For those patches that are still under development, I use <span 
class="pcrr7tn-">devel</span>.
     </span><li><span class="dt">
     </span><span class="dd">A backport patch may have several guards, one for each version of the kernel to which it applies. For example,
     a patch that backports a piece of code to&#x00A0;2.6.9 will have a&#x00A0;<span 
class="pcrr7tn-">2.6.9 </span>guard.</li></ul>
<!--l. 277--><p class="noindent">This variety of guards gives me considerable flexibility in qdetermining what kind of source tree I want to end up with. For most
situations, the selection of appropriate guards is automated during the build process, but I can manually tune the guards to use
for less common circumstances.
                                                                                         
                                                                                         
</p><!--l. 283--><p class="noindent">
</p>
   <h4 class="subsectionHead"><span class="titlemark">13.8.1    </span> <a 
 id="x17-31200013.8.1"></a>The art of writing backport patches</h4>
<!--l. 285--><p class="noindent">Using MQ, writing a backport patch is a simple process. All such a patch has to do is modify a piece of code that uses a kernel
feature not present in the older version of the kernel, so that the driver continues to work correctly under that older
version.
</p><!--l. 290--><p class="indent">   A useful goal when writing a good backport patch is to make your code look as if it was written for the older version of the
kernel you&#x2019;re targeting. The less obtrusive the patch, the easier it will be to understand and maintain. If you&#x2019;re
writing a collection of backport patches to avoid the &#x201C;rat&#x2019;s nest&#x201D; effect of lots of <span 
class="pcrr7tn-">#ifdef</span>s (hunks of source code
that are only used conditionally) in your code, don&#x2019;t introduce version-dependent <span 
class="pcrr7tn-">#ifdef</span>s into the patches.
Instead, write several patches, each of which makes unconditional changes, and control their application using
guards.
</p><!--l. 301--><p class="indent">   There are two reasons to divide backport patches into a distinct group, away from the &#x201C;regular&#x201D; patches whose effects they
modify. The first is that intermingling the two makes it more difficult to use a tool like the <a 
 id="dx17-312001"></a><span 
class="pcrr7tn-">patchbomb </span>extension to automate the
process of submitting the patches to an upstream maintainer. The second is that a backport patch could perturb the context in
which a subsequent regular patch is applied, making it impossible to apply the regular patch cleanly <span 
class="ptmri7t-">without </span>the earlier backport
patch already being applied.
</p><!--l. 311--><p class="noindent">
</p>
   <h3 class="sectionHead"><span class="titlemark">13.9    </span> <a 
 id="x17-31300013.9"></a>Useful tips for developing with MQ</h3>
<!--l. 313--><p class="noindent">
</p>
   <h4 class="subsectionHead"><span class="titlemark">13.9.1    </span> <a 
 id="x17-31400013.9.1"></a>Organising patches in directories</h4>
<!--l. 315--><p class="noindent">If you&#x2019;re working on a substantial project with MQ, it&#x2019;s not difficult to accumulate a large number of patches. For example, I
have one patch repository that contains over 250 patches.
</p><!--l. 319--><p class="indent">   If you can group these patches into separate logical categories, you can if you like store them in different directories; MQ
has no problems with patch names that contain path separators.
</p><!--l. 323--><p class="noindent">
</p>
   <h4 class="subsectionHead"><span class="titlemark">13.9.2    </span> <a 
 id="x17-31500013.9.2"></a>Viewing the history of a patch</h4>
<!--l. 326--><p class="noindent">If you&#x2019;re developing a set of patches over a long time, it&#x2019;s a good idea to maintain them in a repository, as discussed in
section&#x00A0;<a 
href="hobbit-sysadmin-guidech12.html#x16-29200012.11">12.11<!--tex4ht:ref: sec:mq:repo --></a>. If you do so, you&#x2019;ll quickly discover that using the <a 
 id="dx17-315001"></a>&#x201C;<span 
class="pcrr7tn-">hg diff</span>&#x201D; command to look at the history of changes to a
patch is unworkable. This is in part because you&#x2019;re looking at the second derivative of the real code (a diff of a diff), but
also because MQ adds noise to the process by modifying time stamps and directory names when it updates a
patch.
</p><!--l. 335--><p class="indent">   However, you can use the <a 
 id="dx17-315002"></a><span 
class="pcrr7tn-">extdiff </span>extension, which is bundled with Mercurial, to turn a diff of two versions of a patch into
something readable. To do this, you will need a third-party package called <a 
 id="dx17-315003"></a><span 
class="pcrr7tn-">patchutils</span>&#x00A0;<span class="cite">[<span 
class="ptmb7t-">?</span>]</span>. This provides a command named
<a 
 id="dx17-315004"></a><span 
class="pcrr7tn-">interdiff</span>, which shows the differences between two diffs as a diff. Used on two versions of the same diff, it generates a diff
that represents the diff from the first to the second version.
</p><!--l. 344--><p class="indent">   You can enable the <a 
 id="dx17-315005"></a><span 
class="pcrr7tn-">extdiff </span>extension in the usual way, by adding a line to the <a 
 id="dx17-315006"></a><span 
class="pcrr7tn-">[extensions] </span>section of your
<a 
 id="dx17-315007"></a><a 
 id="dx17-315008"></a><span 
class="pcrr7tn-">hgrc</span>.
</p>
   <div class="fancyvrb" id="fancyvrb">
                                                                                         
                                                                                         
<a 
 id="x17-315010r1"></a><span 
class="ptmr7t-x-x-50">1</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;[extensions]</span>
<br class="fancyvrb" /><a 
 id="x17-315012r2"></a><span 
class="ptmr7t-x-x-50">2</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;extdiff</span><span 
class="pcrr7tn-">&#x00A0;=</span>
   </div>
<!--l. 350--><p class="noindent">The <a 
 id="dx17-315013"></a><span 
class="pcrr7tn-">interdiff </span>command expects to be passed the names of two files, but the <a 
 id="dx17-315014"></a><span 
class="pcrr7tn-">extdiff </span>extension passes the program it runs a pair
of directories, each of which can contain an arbitrary number of files. We thus need a small program that will run <a 
 id="dx17-315015"></a><span 
class="pcrr7tn-">interdiff</span>
on each pair of files in these two directories. This program is available as <a 
 id="dx17-315016"></a><span 
class="pcrr7tn-">hg-interdiff </span>in the <span 
class="pcrr7tn-">examples </span>directory of the
source code repository that accompanies this book.
</p>
   <div class="fancyvrb" id="fancyvrb">
<a 
 id="x17-315018r1"></a><span 
class="ptmr7t-x-x-50">1</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;#!/usr/bin/env</span><span 
class="pcrr7tn-">&#x00A0;python</span>
<br class="fancyvrb" /><a 
 id="x17-315020r2"></a><span 
class="ptmr7t-x-x-50">2</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;#</span>
<br class="fancyvrb" /><a 
 id="x17-315022r3"></a><span 
class="ptmr7t-x-x-50">3</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;#</span><span 
class="pcrr7tn-">&#x00A0;Adapter</span><span 
class="pcrr7tn-">&#x00A0;for</span><span 
class="pcrr7tn-">&#x00A0;using</span><span 
class="pcrr7tn-">&#x00A0;interdiff</span><span 
class="pcrr7tn-">&#x00A0;with</span><span 
class="pcrr7tn-">&#x00A0;mercurial's</span><span 
class="pcrr7tn-">&#x00A0;extdiff</span><span 
class="pcrr7tn-">&#x00A0;extension.</span>
<br class="fancyvrb" /><a 
 id="x17-315024r4"></a><span 
class="ptmr7t-x-x-50">4</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;#</span>
<br class="fancyvrb" /><a 
 id="x17-315026r5"></a><span 
class="ptmr7t-x-x-50">5</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;#</span><span 
class="pcrr7tn-">&#x00A0;Copyright</span><span 
class="pcrr7tn-">&#x00A0;2006</span><span 
class="pcrr7tn-">&#x00A0;Bryan</span><span 
class="pcrr7tn-">&#x00A0;O'Sullivan</span><span 
class="pcrr7tn-">&#x00A0;&#x003c;bos@serpentine.com&#x003e;</span>
<br class="fancyvrb" /><a 
 id="x17-315028r6"></a><span 
class="ptmr7t-x-x-50">6</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;#</span>
<br class="fancyvrb" /><a 
 id="x17-315030r7"></a><span 
class="ptmr7t-x-x-50">7</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;#</span><span 
class="pcrr7tn-">&#x00A0;This</span><span 
class="pcrr7tn-">&#x00A0;software</span><span 
class="pcrr7tn-">&#x00A0;may</span><span 
class="pcrr7tn-">&#x00A0;be</span><span 
class="pcrr7tn-">&#x00A0;used</span><span 
class="pcrr7tn-">&#x00A0;and</span><span 
class="pcrr7tn-">&#x00A0;distributed</span><span 
class="pcrr7tn-">&#x00A0;according</span><span 
class="pcrr7tn-">&#x00A0;to</span><span 
class="pcrr7tn-">&#x00A0;the</span><span 
class="pcrr7tn-">&#x00A0;terms</span><span 
class="pcrr7tn-">&#x00A0;of</span>
<br class="fancyvrb" /><a 
 id="x17-315032r8"></a><span 
class="ptmr7t-x-x-50">8</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;#</span><span 
class="pcrr7tn-">&#x00A0;the</span><span 
class="pcrr7tn-">&#x00A0;GNU</span><span 
class="pcrr7tn-">&#x00A0;General</span><span 
class="pcrr7tn-">&#x00A0;Public</span><span 
class="pcrr7tn-">&#x00A0;License,</span><span 
class="pcrr7tn-">&#x00A0;incorporated</span><span 
class="pcrr7tn-">&#x00A0;herein</span><span 
class="pcrr7tn-">&#x00A0;by</span><span 
class="pcrr7tn-">&#x00A0;reference.</span>
<br class="fancyvrb" /><a 
 id="x17-315034r9"></a><span 
class="ptmr7t-x-x-50">9</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x17-315036r10"></a><span 
class="ptmr7t-x-x-50">10</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;import</span><span 
class="pcrr7tn-">&#x00A0;os,</span><span 
class="pcrr7tn-">&#x00A0;sys</span>
<br class="fancyvrb" /><a 
 id="x17-315038r11"></a><span 
class="ptmr7t-x-x-50">11</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x17-315040r12"></a><span 
class="ptmr7t-x-x-50">12</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;def</span><span 
class="pcrr7tn-">&#x00A0;walk(base):</span>
<br class="fancyvrb" /><a 
 id="x17-315042r13"></a><span 
class="ptmr7t-x-x-50">13</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;#</span><span 
class="pcrr7tn-">&#x00A0;yield</span><span 
class="pcrr7tn-">&#x00A0;all</span><span 
class="pcrr7tn-">&#x00A0;non-directories</span><span 
class="pcrr7tn-">&#x00A0;below</span><span 
class="pcrr7tn-">&#x00A0;the</span><span 
class="pcrr7tn-">&#x00A0;base</span><span 
class="pcrr7tn-">&#x00A0;path.</span>
<br class="fancyvrb" /><a 
 id="x17-315044r14"></a><span 
class="ptmr7t-x-x-50">14</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;for</span><span 
class="pcrr7tn-">&#x00A0;root,</span><span 
class="pcrr7tn-">&#x00A0;dirs,</span><span 
class="pcrr7tn-">&#x00A0;files</span><span 
class="pcrr7tn-">&#x00A0;in</span><span 
class="pcrr7tn-">&#x00A0;os.walk(base):</span>
<br class="fancyvrb" /><a 
 id="x17-315046r15"></a><span 
class="ptmr7t-x-x-50">15</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;for</span><span 
class="pcrr7tn-">&#x00A0;f</span><span 
class="pcrr7tn-">&#x00A0;in</span><span 
class="pcrr7tn-">&#x00A0;files:</span>
<br class="fancyvrb" /><a 
 id="x17-315048r16"></a><span 
class="ptmr7t-x-x-50">16</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;path</span><span 
class="pcrr7tn-">&#x00A0;=</span><span 
class="pcrr7tn-">&#x00A0;os.path.join(root,</span><span 
class="pcrr7tn-">&#x00A0;f)</span>
<br class="fancyvrb" /><a 
 id="x17-315050r17"></a><span 
class="ptmr7t-x-x-50">17</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;yield</span><span 
class="pcrr7tn-">&#x00A0;path[len(base)+1:],</span><span 
class="pcrr7tn-">&#x00A0;path</span>
<br class="fancyvrb" /><a 
 id="x17-315052r18"></a><span 
class="ptmr7t-x-x-50">18</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;else:</span>
<br class="fancyvrb" /><a 
 id="x17-315054r19"></a><span 
class="ptmr7t-x-x-50">19</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;if</span><span 
class="pcrr7tn-">&#x00A0;os.path.isfile(base):</span>
<br class="fancyvrb" /><a 
 id="x17-315056r20"></a><span 
class="ptmr7t-x-x-50">20</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;yield</span><span 
class="pcrr7tn-">&#x00A0;'',</span><span 
class="pcrr7tn-">&#x00A0;base</span>
<br class="fancyvrb" /><a 
 id="x17-315058r21"></a><span 
class="ptmr7t-x-x-50">21</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x17-315060r22"></a><span 
class="ptmr7t-x-x-50">22</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;#</span><span 
class="pcrr7tn-">&#x00A0;create</span><span 
class="pcrr7tn-">&#x00A0;list</span><span 
class="pcrr7tn-">&#x00A0;of</span><span 
class="pcrr7tn-">&#x00A0;unique</span><span 
class="pcrr7tn-">&#x00A0;file</span><span 
class="pcrr7tn-">&#x00A0;names</span><span 
class="pcrr7tn-">&#x00A0;under</span><span 
class="pcrr7tn-">&#x00A0;both</span><span 
class="pcrr7tn-">&#x00A0;directories.</span>
<br class="fancyvrb" /><a 
 id="x17-315062r23"></a><span 
class="ptmr7t-x-x-50">23</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;files</span><span 
class="pcrr7tn-">&#x00A0;=</span><span 
class="pcrr7tn-">&#x00A0;dict(walk(sys.argv[1]))</span>
<br class="fancyvrb" /><a 
 id="x17-315064r24"></a><span 
class="ptmr7t-x-x-50">24</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;files.update(walk(sys.argv[2]))</span>
<br class="fancyvrb" /><a 
 id="x17-315066r25"></a><span 
class="ptmr7t-x-x-50">25</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;files</span><span 
class="pcrr7tn-">&#x00A0;=</span><span 
class="pcrr7tn-">&#x00A0;files.keys()</span>
<br class="fancyvrb" /><a 
 id="x17-315068r26"></a><span 
class="ptmr7t-x-x-50">26</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;files.sort()</span>
<br class="fancyvrb" /><a 
 id="x17-315070r27"></a><span 
class="ptmr7t-x-x-50">27</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x17-315072r28"></a><span 
class="ptmr7t-x-x-50">28</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;def</span><span 
class="pcrr7tn-">&#x00A0;name(base,</span><span 
class="pcrr7tn-">&#x00A0;f):</span>
<br class="fancyvrb" /><a 
 id="x17-315074r29"></a><span 
class="ptmr7t-x-x-50">29</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;if</span><span 
class="pcrr7tn-">&#x00A0;f:</span>
<br class="fancyvrb" /><a 
 id="x17-315076r30"></a><span 
class="ptmr7t-x-x-50">30</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;path</span><span 
class="pcrr7tn-">&#x00A0;=</span><span 
class="pcrr7tn-">&#x00A0;os.path.join(base,</span><span 
class="pcrr7tn-">&#x00A0;f)</span>
<br class="fancyvrb" /><a 
 id="x17-315078r31"></a><span 
class="ptmr7t-x-x-50">31</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;else:</span>
<br class="fancyvrb" /><a 
 id="x17-315080r32"></a><span 
class="ptmr7t-x-x-50">32</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;path</span><span 
class="pcrr7tn-">&#x00A0;=</span><span 
class="pcrr7tn-">&#x00A0;base</span>
<br class="fancyvrb" /><a 
 id="x17-315082r33"></a><span 
class="ptmr7t-x-x-50">33</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;#</span><span 
class="pcrr7tn-">&#x00A0;interdiff</span><span 
class="pcrr7tn-">&#x00A0;requires</span><span 
class="pcrr7tn-">&#x00A0;two</span><span 
class="pcrr7tn-">&#x00A0;files;</span><span 
class="pcrr7tn-">&#x00A0;use</span><span 
class="pcrr7tn-">&#x00A0;/dev/null</span><span 
class="pcrr7tn-">&#x00A0;if</span><span 
class="pcrr7tn-">&#x00A0;one</span><span 
class="pcrr7tn-">&#x00A0;is</span><span 
class="pcrr7tn-">&#x00A0;missing.</span>
<br class="fancyvrb" /><a 
 id="x17-315084r34"></a><span 
class="ptmr7t-x-x-50">34</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;if</span><span 
class="pcrr7tn-">&#x00A0;os.path.exists(path):</span>
<br class="fancyvrb" /><a 
 id="x17-315086r35"></a><span 
class="ptmr7t-x-x-50">35</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;return</span><span 
class="pcrr7tn-">&#x00A0;path</span>
<br class="fancyvrb" /><a 
 id="x17-315088r36"></a><span 
class="ptmr7t-x-x-50">36</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;return</span><span 
class="pcrr7tn-">&#x00A0;'/dev/null'</span>
<br class="fancyvrb" /><a 
 id="x17-315090r37"></a><span 
class="ptmr7t-x-x-50">37</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x17-315092r38"></a><span 
class="ptmr7t-x-x-50">38</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;ret</span><span 
class="pcrr7tn-">&#x00A0;=</span><span 
class="pcrr7tn-">&#x00A0;0</span>
<br class="fancyvrb" /><a 
 id="x17-315094r39"></a><span 
class="ptmr7t-x-x-50">39</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x17-315096r40"></a><span 
class="ptmr7t-x-x-50">40</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;for</span><span 
class="pcrr7tn-">&#x00A0;f</span><span 
class="pcrr7tn-">&#x00A0;in</span><span 
class="pcrr7tn-">&#x00A0;files:</span>
<br class="fancyvrb" /><a 
 id="x17-315098r41"></a><span 
class="ptmr7t-x-x-50">41</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;if</span><span 
class="pcrr7tn-">&#x00A0;os.system('interdiff</span><span 
class="pcrr7tn-">&#x00A0;"%s"</span><span 
class="pcrr7tn-">&#x00A0;"%s"'</span><span 
class="pcrr7tn-">&#x00A0;%</span><span 
class="pcrr7tn-">&#x00A0;(name(sys.argv[1],</span><span 
class="pcrr7tn-">&#x00A0;f),</span>
<br class="fancyvrb" /><a 
 id="x17-315100r42"></a><span 
class="ptmr7t-x-x-50">42</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;name(sys.argv[2],</span><span 
class="pcrr7tn-">&#x00A0;f))):</span>
                                                                                         
                                                                                         
<br class="fancyvrb" /><a 
 id="x17-315102r43"></a><span 
class="ptmr7t-x-x-50">43</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;ret</span><span 
class="pcrr7tn-">&#x00A0;=</span><span 
class="pcrr7tn-">&#x00A0;1</span>
<br class="fancyvrb" /><a 
 id="x17-315104r44"></a><span 
class="ptmr7t-x-x-50">44</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;</span>
<br class="fancyvrb" /><a 
 id="x17-315106r45"></a><span 
class="ptmr7t-x-x-50">45</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;sys.exit(ret)</span>
   </div>
<!--l. 359--><p class="indent">   With the <a 
 id="dx17-315107"></a><span 
class="pcrr7tn-">hg-interdiff </span>program in your shell&#x2019;s search path, you can run it as follows, from inside an MQ patch
directory:
</p>
   <div class="fancyvrb" id="fancyvrb">
<a 
 id="x17-315109r1"></a><span 
class="ptmr7t-x-x-50">1</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;hg</span><span 
class="pcrr7tn-">&#x00A0;extdiff</span><span 
class="pcrr7tn-">&#x00A0;-p</span><span 
class="pcrr7tn-">&#x00A0;hg-interdiff</span><span 
class="pcrr7tn-">&#x00A0;-r</span><span 
class="pcrr7tn-">&#x00A0;A:B</span><span 
class="pcrr7tn-">&#x00A0;my-change.patch</span>
   </div>
<!--l. 364--><p class="noindent">Since you&#x2019;ll probably want to use this long-winded command a lot, you can get <a 
 id="dx17-315110"></a><span 
class="pcrr7tn-">hgext </span>to make it available as a normal Mercurial
command, again by editing your <a 
 id="dx17-315111"></a><a 
 id="dx17-315112"></a><span 
class="pcrr7tn-">hgrc</span>.
</p>
   <div class="fancyvrb" id="fancyvrb">
<a 
 id="x17-315114r1"></a><span 
class="ptmr7t-x-x-50">1</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;[extdiff]</span>
<br class="fancyvrb" /><a 
 id="x17-315116r2"></a><span 
class="ptmr7t-x-x-50">2</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;cmd.interdiff</span><span 
class="pcrr7tn-">&#x00A0;=</span><span 
class="pcrr7tn-">&#x00A0;hg-interdiff</span>
   </div>
<!--l. 371--><p class="noindent">This directs <a 
 id="dx17-315117"></a><span 
class="pcrr7tn-">hgext </span>to make an <span 
class="pcrr7tn-">interdiff </span>command available, so you can now shorten the previous invocation of <a 
 id="dx17-315118"></a><a 
 id="dx17-315119"></a>&#x201C;<span 
class="pcrr7tn-">hg extdiff</span>&#x201D;
to something a little more wieldy.
</p>
   <div class="fancyvrb" id="fancyvrb">
<a 
 id="x17-315121r1"></a><span 
class="ptmr7t-x-x-50">1</span><span 
class="pcrr7tn-">&#x00A0;</span><span 
class="pcrr7tn-">&#x00A0;hg</span><span 
class="pcrr7tn-">&#x00A0;interdiff</span><span 
class="pcrr7tn-">&#x00A0;-r</span><span 
class="pcrr7tn-">&#x00A0;A:B</span><span 
class="pcrr7tn-">&#x00A0;my-change.patch</span>
   </div>
</p>
   <div class="fbox"><span 
class="ptmb7t-">Note:   </span>The <span 
class="pcrr7tn-">interdiff </span>command works well only if the underlying files against
which versions of a patch are generated remain the same. If you create a patch,
modify the underlying files, and then regenerate the patch, <span 
class="pcrr7tn-">interdiff </span>may not
produce useful output.                                                                                                </div>
<!--l. 386--><p class="indent">   The <a 
 id="dx17-315124"></a><span 
class="pcrr7tn-">extdiff </span>extension is useful for more than merely improving the presentation of MQ&#x00A0;patches. To read more about it,
go to section&#x00A0;<a 
href="hobbit-sysadmin-guidech14.html#x18-31800014.2">14.2<!--tex4ht:ref: sec:hgext:extdiff --></a>.
                                                                                         
                                                                                         
                                                                                         
                                                                                         
                                                                                         
                                                                                         
</p>
   <!--l. 1--><div class="crosslinks"><p class="noindent">[<a 
href="hobbit-sysadmin-guidech14.html" >next</a>] [<a 
href="hobbit-sysadmin-guidech12.html" >prev</a>] [<a 
href="hobbit-sysadmin-guidech12.html#tailhobbit-sysadmin-guidech12.html" >prev-tail</a>] [<a 
href="hobbit-sysadmin-guidech13.html" >front</a>] [<a 
href="hobbit-sysadmin-guide.html#hobbit-sysadmin-guidech13.html" >up</a>] </p></div>
<!--l. 1--><p class="indent">   <a 
 id="tailhobbit-sysadmin-guidech13.html"></a>   </p> 
</body></html> 
