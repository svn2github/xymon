%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Data Backend}
\section{HOBBITD\_RRD}

 xymond\_rrd - hobbitd worker module for updating xymon RRD files

\subsection{SYNOPSIS}
\textbf{xymond\_channel --channel=status hobbitd\_rrd [options]}
 
\textbf{xymond\_channel --channel=data hobbitd\_rrd [options]}


 
\subsection{DESCRIPTION}
 xymond\_rrd is a worker module for hobbitd, and as such it is normally run via the \emph{hobbitd\_channel(8)}
 program. It receives ``status'' and ``data'' messages from xymond via stdin, and updates the RRD databases used to generate trend-graphs. 

  Clients can send data to xymon using both status- and data- messages. So you will normally run two instances of this module, once for the ``status'' channel and once for the ``data'' channel. 


  xymond\_rrd understands data sent by the LARRD 0.43c client-side scripts (the so-called ``bottom-feeder'' scripts). So you still want to install the LARRD bottom-feeders on the clients you monitor. 


  Note: For certain types of data, the RRD files used by xymon are imcompatible with those generated by the Big Brother LARRD add-on. See the COMPATIBILITY section below. 


 


 
\subsection{OPTIONS}
\begin{description}
\item[--debug] Enable debugging output. 

 

\item[--rrddir=DIRECTORY] Defines the directory where the RRD-files are stored. xymond\_rrd will use the location pointed to by the BBRRDS environment if this option is not present. 

 

\item[--extra-script=FILENAME] Defines the script that is run to get the RRD data for tests that are not built into xymond\_rrd. You must also specify which tests are handled by the external script in the \textbf{--extra-tests}
 option. This option can only be given once, so the script must handle all of the external test-data. See the CUSTOM RRD DATA section below. Note that this is NOT needed if your custom graphs are generated by the NCV (Name Colon Value) module described below, it is only required for data where you have a custom script to parse the status message and extract the data that is put into the graph. 

 

\item[--extra-tests=TEST[,TEST]] List of testnames that are handled by the external script. See the CUSTOM RRD DATA section below. Note that NCV graphs should NOT be listed here, but in the TEST2RRD environment variable - see below. 

 

\item[--processor=COMMAND] Feed the raw RRD data into COMMAND via standard input. COMMAND must be a simple command with no options; if necessary, COMMAND can be a script that runs the real command with the necessary options. The data sent to COMMAND consists of lines of text of the form  
 
dsname1[:dsname2]time:value1[:value2]rrdtype[key1][key2]  
 First the dataset names, corresponding to the DS definitions in the RRD files. Next the timestamp of the update, followed by the values in the same order as the dsname-list. Third item is the hostname, fourth is the type of RRD file. After that there may be between 0-2 additional keys: For ``disk'' this is the filesystem mountpoint, for ``tcp'' tests it is the service name, for ``tcp'' ``http'' tests there is also the URL checked. Note that filesystem names and URLs have forward slash substituted by comma. See the xymond/rrd/*.c sourcecode for details, look for the ``setupfn'' function calls. An example:  


 \begin{verbatim}

la 1196115478:7 myhost la
la 1196115478:169 myhost procs
la 1196115478:1 myhost users
la 1196115478:244 myhost clock
pct:used 1196115478:63:62338144 myhost disk ,root
realmempct 1196115478:76 myhost memory real
realmempct 1196115478:0 myhost memory swap
realmempct 1196115478:20 myhost memory actual
sec 1196115478:0.03 tcp myhost conn
sec 1196115478:1.38 myhost tcp http www.xymon.com,

\end{verbatim}



 


 


 


\end{description}
\subsection{ENVIRONMENT}
\begin{description}
\item[TEST2RRD] Defines the mapping between a status-log columnname and the corresponding RRD database format. This is normally defined in the \emph{xymonserver.cfg(5)}
 file. 

 

\item[BBRRDS] Default directory where RRD files are stored. 

 

\item[NCV\_testname] Defines the types of data collected by the ``ncv'' module in xymond\_rrd. See below for more information. 

 


\end{description}
\subsection{COLLECTED DATA}
 The following RRD-file datasets are generated by xymond\_rrd: 

 \begin{description}
\item[la] Records the CPU load average. Data is collected from the ``cpu'' status report. Requires that a xymon client is running on the monitored server. 

 

\item[disk] Records the disk utilization. Data is collected from the ``disk'' status report. Requires that a xymon-compatible client is running on the monitored server. 

 

\item[memory] Records memory- and swap-utilization. Data is collected from the ``memory'' status report. If no ``memory'' status is reported, it will use the data from the Win32 client ``cpu'' status report to generate this dataset. Requires that a xymon-compatible client is running on the monitored server. 

 

\item[netstat] Records TCP and UDP statistics. Data is collected from the ``netstat'' status report; however, this data is often sent via the xymon ``data'' protocol, so there need not be a ``netstat'' column visible on the Xymon display. To get these data, the LARRD netstat bottom-feeder script must be running on the monitored server. 

 

\item[vmstat] Records system performance metrics from the ``vmstat'' command. Data is collected from the ``vmstat'' status report; however, this data is often sent via the xymon ``data'' protocol, so there need not be a ``vmstat'' column visible on the Xymon display. To get these data, the LARRD vmstat bottom-feeder script must be running on the monitored server. 

 

\item[tcp] Response-time metrics from all of the xymon network tests are recorded in the ``tcp'' RRD. 

 

\item[apache] Apache server performance metrics, taken from the ``apache'' data report. See the description of the \textbf{apache}
 keyword in \emph{bb-hosts(5)}
 for details. 

 

\item[sendmail] Sendmail server performance metrics, taken from the ``mailstats'' output. To get these data, the LARRD sendmail bottom-feeder script must be running on the monitored server. 

 

\item[mailq] Mail queue size. To get these data, the LARRD nmailq bottom-feeder script must be running on the monitored server. 

 

\item[bea] BEA Weblogic performance data. This is an experimental set of data collected from BEA Weblogic servers via SNMP, by the ``beastats'' tool included with xymon. 

 

\item[iishealth] IIS webserver performance data, collected by the ``iishealth'' script. This script is a client-side add-on available from the www.deadcat.net archive. 

 

\item[temperature] Temperature data, collected with the temperature script from www.deadcat.net. To get these data, the temperature script must be running on the monitored server. 

 

\item[ntpstat] Tracks the deviation between the local system time and an NTP server, using the output from the ``ntpq -c rv'' command. A simple script to collect these data is included in the xymon contrib/ directory. 

 

\item[citrix] Tracks the number of active sessions on a Citrix server using the ``query session'' command. An extension for the BBNT client that generates data for this graph is in the xymon contrib/ directory. 

 


 


\end{description}

\subsection{CUSTOM RRD DATA IN NAME-COLON-VALUE (NCV) FORMAT}
 Many data-collection scripts report data in the form ``NAME : value'' or ``NAME = value''. So a generic module in xymond\_rrd allows for easy tracking of this type of data. 

  The ``ncv'' module will automatically detect all occurrences of a ``NAME : value'' or ``NAME = value'' string in a status message, and generate an RRD file holding all of the name/value data found in the message. The colon- or equal-sign must be present - if there is only whitespace, this module will fail. 


  Only the valid letters (A-Z, a-z) and digits (0-9) are used in the dataset names; whitespace and other characters are stripped off automatically. Only the first 19 characters of a dataset name are used (this is an RRD limitation). Underscore '\_' is not allowed, even though RRDtool permits this, and will be stripped from the name. 


  Note that each ``NAME : value'' must be on a line by itself. If you have a custom script generating the status- or data-message that is fed into the NCV handler, make sure it inserts a newline before each of the data-items you want to track. 


  To enable the ncv module for a status, add a ``COLUMNNAME=ncv'' to the TEST2RRD setting and the COLUMNNAME to the GRAPHS setting in \emph{xymonserver.cfg(5)}
 , then restart xymon. Xymon will now send all status-messages for the column COLUMNNAME through the xymond\_rrd ncv-handler. 


  The name of the RRD file will be COLUMNNAME.rrd. 


  By default, all of the datasets are generated as the RRD type ``DERIVE'' which works for all types of monotonically increasing counters. If you have data that are of the type GAUGE, you can override the default via an environment variable NCV\_COLUMNNAME. 


  E.g. if you are using the bb-mysqlstatus script from www.deadcat.net to collect data about your MySQL server, it generates a report in the column called ``mysql''. One data item is the average number of queries/second, which must be logged in the RRD file as type ``GAUGE''. To do that, add the following to xymonserver.cfg:  
 
NCV\_mysql=''Queriespersecondavg:GAUGE''  
 If you have multiple datasets that you myst define, add them to the environment variable separated by commas, e.g.  
 
NCV\_mysql=''Uptime:NONE,Queriespersecondavg:GAUGE''  



  The dataset type ``NONE'' used above causes xymond\_rrd to ignore this data, it is not included in the RRD file. 


  You can use ``*'' as the dataset name to match all datasets not listed. E.g.  
 
NCV\_weather=''Rain:DERIVE,*:GAUGE''  
 will cause the ``Rainfall'' dataset to be of type DERIVE, and all others of type GAUGE. If you want to track only a few of the variables in your data, you can use ``*:NONE'' to drop any dataset not explicitly listed. 


  For a more detailed ``how to'' description, see the on-line HTML documentation of ``How to create graph custom data'' available in the Help menu section on your xymon server. 


 


 
\subsection{CUSTOM RRD DATA VIA SCRIPTS}
 xymond\_rrd provides a simple mechanism for adding custom graphs to the set of data collected on your xymon server. By adding the ``--extra-script'' and ``--extra-tests'' options, data reported to Xymon from selected tests are passed to an external script, which can define the RRD data-sets to store in an RRD file. 

 \textbf{NOTE:}
 For performance reasons, you should not use this mechanism for large amounts of data. The overhead involved in storing the received message to disk and launching the script is significantly larger than the normal xymond\_rrd overhead. So if you have a large number of reports for a given test, you should consider implementing it in C and including it in the hobbitd\_rrd tool. 


  Apart from writing the script, You must also add a section to \emph{xymongraph.cfg(5)}
 so that \emph{xymongraph.cgi(1)}
 knows how to generate the graph from the data stored in the RRD file. To make the graphs actually show up on the status-page and/or the ``trends'' page, add the name of the new graph to the TEST2RRD and/or GRAPHS setting in \emph{xymonserver.cfg(5).}



  The script is invoked for each message that arrives, where the test-name matches one of the testnames given in the ``--extra-tests'' option. The script receives three commandline parameters: 


 \begin{description}
\item[\textbf{Hostname}
] The name of the host reporting the data. 
\item[\textbf{Testname}
] The name of the test being reported. 
\item[\textbf{Filename}
] File containing the data that was reported. This file is generated for you by xymond\_rrd, and is also deleted automatically after your script is finished with it. 

 


\end{description}



  The script must process the data that is reported, and generate the following output: 


 \begin{description}
\item[\textbf{RRD data-set definitions}
] For each dataset that the RRD file holds, a line beginning with ``DS:'' must be output. If multiple data-sets are used, print one line for each dataset.  
 Data-set definitions are described in the \emph{rrdcreate(1)}
 documentation, but a common definition for e.g. tracking the number of users logged on would be ``DS:users:GAUGE:600:0:U''. ``users'' is the name of the dataset, ``GAUGE'' is the datatype, ``600'' is the longest time allowed between updates for the data to be valid, ``0'' is the minimum value, and ``U'' is the maximum value (a ``U'' means ``unknown''). 
\item[\textbf{RRD filename}
] The name of the RRD file where the data is stored. Note that xymon stores all RRD files in host-specific directories, so unlike LARRD you should not include the hostname in the name of the RRD file. 
\item[\textbf{RRD values}
] One line, with all of the data values collected by the script. Data-items are colon-delimited and must appear in the same sequence as your data-set definitions, e.g. if your RRD has two datasets with the values ``5'' and ``0.4'' respectively, then the script must output ``5:0.4'' as the RRD values.  
 In some cases it may be useful to define a dataset even though you will not always have data for it. In that case, use ``U'' (unknown) for the value. 

  If you want to store the data in multiple RRD files, the script can just print out more sequences of data-set definitions, RRD filenames and RRD values. If the data-set definitions are identical to the previous definition, you need not print the data-set definitions again - just print a new RRD filename and value. 


 


\end{description}



  The following sample script for tracking weather data shows how to use this mechanism. It assumes the status message include lines like these: \begin{description}
\item[]\begin{verbatim}

green Weather in Copenhagen is FAIR

Temperature: 21 degrees Celsius
Wind: 4 m/s
Humidity: 72 %
Rainfall: 5 mm since 6:00 AM

\end{verbatim}


\end{description}



  A shell-script to track all of these variables could be written like this: \begin{description}
\item[]\begin{verbatim}

#!/bin/sh

# Input parameters: Hostname, testname (column), and messagefile
HOSTNAME="$1"
TESTNAME="$2"
FNAME="$3"

if [ "$TESTNAME" = "weather" ]
then
        # Analyze the message we got
        TEMP=`grep "^Temperature:" $FNAME | awk '{print $2}'`
        WIND=`grep "^Wind:" $FNAME | awk '{print $2}'`
        HMTY=`grep "^Humidity:" $FNAME | awk '{print $2}'`
        RAIN=`grep "^Rainfall:" $FNAME | awk '{print $2}'`

        # The RRD dataset definitions
        echo "DS:temperature:GAUGE:600:-30:50"
        echo "DS:wind:GAUGE:600:0:U"
        echo "DS:humidity:GAUGE:600:0:100"
        echo "DS:rainfall:DERIVE:600:0:100"

        # The filename
        echo "weather.rrd"

        # The data
        echo "$TEMP:$WIND:$HMTY:$RAIN"
fi

exit 0

\end{verbatim}


 


 


\end{description}

\subsection{COMPATIBILITY}


  Some of the RRD files generated by xymond\_rrd are incompatible
  with the files generated by the Big Brother LARRD add-on: 



\begin{description}

\item[vmstat] The vmstat files with data from Linux based systems are
  incompatible due to the addition of a number of new data-items that
  LARRD 0.43 do not collect, but xymond\_rrd does. This is due to
  changes in the output from the Linux vmstat command, and changes in
  the way e.g. system load metrics are reported. 
 

\item[netstat] All netstat files from LARRD 0.43 are incompatible with
  xymond\_rrd. The netstat data collected by LARRD is quite
  confusing: For some types of systems LARRD collects packet-counts,
  for others it collects byte- counts. xymond\_rrd uses a different
  RRD file-format with separate counters for packets and bytes and
  tracks whatever data the system is reporting. 


 


 


\end{description}

\subsection{SEE ALSO}
xymond\_channel(8), hobbitd(8), hobbitserver.cfg(5), hobbit(7) 

